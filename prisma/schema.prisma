generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum FormStatus {
  draft
  published
}

enum QuestionType {
  short_text
  long_text
  single_choice
  multiple_choice
  email
  phone
  consent
}

model Form {
  id                  String        @id @default(cuid())
  name                String
  slug                String        @unique
  status              FormStatus    @default(draft)
  introTitle          String?
  introDescription    String?
  thankYouTitle       String?       @default("Thank you!")
  thankYouMessage     String?       @default("Your response has been recorded.")
  redirectUrl         String?
  redirectDelaySec    Int?          @default(5)
  webhookUrl          String?
  webhookEnabled      Boolean       @default(false)
  webhookSecret       String?
  distributionEnabled Boolean       @default(false)
  publishedVersionId  String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  questions           Question[]
  versions            FormVersion[]
  submissions         Submission[]
  webhookDeliveries   WebhookDelivery[]
  crmDeliveries       CrmDelivery[]
  distributionClients FormDistributionClient[]
  publishedVersion    FormVersion?  @relation("PublishedVersion", fields: [publishedVersionId], references: [id])
}

model FormVersion {
  id            String   @id @default(cuid())
  formId        String
  versionNumber Int
  snapshotJson  Json
  createdAt     DateTime @default(now())

  form              Form   @relation(fields: [formId], references: [id], onDelete: Cascade)
  publishedForForms Form[] @relation("PublishedVersion")

  @@unique([formId, versionNumber])
}

model Question {
  id         String       @id @default(cuid())
  formId     String
  key        String
  type       QuestionType
  label      String
  required   Boolean      @default(false)
  order      Int
  configJson Json?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@unique([formId, key])
}

model Submission {
  id        String   @id @default(cuid())
  formId    String
  createdAt DateTime @default(now())
  ip        String?
  userAgent String?
  referrer  String?
  utmJson   Json?

  form          Form          @relation(fields: [formId], references: [id], onDelete: Cascade)
  answers       Answer[]
  crmDeliveries CrmDelivery[]
}

model Answer {
  id            String @id @default(cuid())
  submissionId  String
  questionKey   String
  questionLabel String
  questionType  String
  valueJson     Json

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
}

model WebhookDelivery {
  id               String    @id @default(cuid())
  formId           String
  submissionId     String
  url              String
  requestBodyJson  Json
  responseStatus   Int?
  responseBodyText String?
  success          Boolean   @default(false)
  attempts         Int       @default(0)
  lastError        String?
  nextAttemptAt    DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)
}

// CRM Lead Distribution Models

model CrmClient {
  id           String   @id @default(cuid())
  name         String
  apiUrl       String
  apiKey       String?
  apiSecret    String?
  httpMethod   String   @default("POST")
  headers      Json?
  fieldMapping Json     @default("{}")
  enabled      Boolean  @default(true)
  priority     Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  quotas      CrmQuota[]
  deliveries  CrmDelivery[]
  formClients FormDistributionClient[]
}

model CrmQuota {
  id         String   @id @default(cuid())
  clientId   String
  leadLimit  Int
  periodDays Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  client CrmClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model CrmDelivery {
  id             String   @id @default(cuid())
  clientId       String
  submissionId   String
  formId         String
  requestBody    Json
  responseStatus Int?
  responseBody   String?
  success        Boolean  @default(false)
  attempts       Int      @default(0)
  lastError      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  client     CrmClient  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  form       Form       @relation(fields: [formId], references: [id], onDelete: Cascade)
}

model FormDistributionClient {
  id       String  @id @default(cuid())
  formId   String
  clientId String
  enabled  Boolean @default(true)
  priority Int?

  form   Form      @relation(fields: [formId], references: [id], onDelete: Cascade)
  client CrmClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([formId, clientId])
}

